<?xml version="1.0" encoding="UTF-8" ?>
<beans
          xmlns="http://www.springframework.org/schema/beans"
          xmlns:security="http://www.springframework.org/schema/security"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:mvc="http://www.springframework.org/schema/mvc"
          xmlns:oauth="http://www.springframework.org/schema/security/oauth2"
          xmlns:util="http://www.springframework.org/schema/util"
          xsi:schemaLocation="http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/security https://www.springframework.org/schema/security/spring-security.xsd
    http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd
    http://www.springframework.org/schema/util https://www.springframework.org/schema/util/spring-util.xsd
    http://www.springframework.org/schema/security/oauth2 https://www.springframework.org/schema/security/spring-security-oauth2-2.0.xsd">

    <oauth:resource id="uaa" access-token-uri="${uaa.token.url:http://localhost:8080/uaa/oauth/token}"
                    client-id="login" client-secret="${LOGIN_SECRET:loginsecret}" type="client_credentials"/>

    <bean id="resetPasswordEntryPoint"
                    class="org.cloudfoundry.identity.uaa.account.ResetPasswordAuthenticationEntryPoint"/>
    <bean id="resetPasswordAuthenticationFilter"
                    class="org.cloudfoundry.identity.uaa.account.ResetPasswordAuthenticationFilter">
        <constructor-arg name="entryPoint" ref="resetPasswordEntryPoint"/>
        <constructor-arg name="handler" ref="accountSavingAuthenticationSuccessHandler"/>
        <constructor-arg name="service" ref="resetPasswordService"/>
        <constructor-arg name="expiringCodeStore" ref="codeStore"/>
    </bean>

    <bean id="uiAuthorizeRequestMatcher" class="org.springframework.security.web.util.matcher.AntPathRequestMatcher">
        <constructor-arg value="/oauth/authorize**"/>
    </bean>

    <bean id="loginCookieCsrfRepository"
                    class="org.cloudfoundry.identity.uaa.security.web.CookieBasedCsrfTokenRepository">
        <property name="secure" value="${require_https:false}"/>
    </bean>

    <bean id="accountSavingAuthenticationSuccessHandler"
                    class="org.cloudfoundry.identity.uaa.login.AccountSavingAuthenticationSuccessHandler">
        <constructor-arg name="redirectingHandler" ref="successRedirectHandler"/>
        <constructor-arg name="currentUserCookieFactory" ref="currentUserCookieFactory"/>
    </bean>

    <bean id="currentUserCookieFactory" class="org.cloudfoundry.identity.uaa.login.CurrentUserCookieFactory">
        <constructor-arg name="sessionTimeout" value="${servlet.session-cookie.max-age:1800}"/>
        <constructor-arg name="secure" value="${require_https:false}"/>
    </bean>

    <bean name="clientRedirectStateCache" class="org.cloudfoundry.identity.uaa.web.UaaSavedRequestCache">
        <property name="requestMatcher" ref="uiAuthorizeRequestMatcher"/>
    </bean>

    <bean id="errorMessageAuthenticationFailureHandler"
                    class="org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler">
        <property name="exceptionMappings">
            <map>
                <entry key="org.cloudfoundry.identity.uaa.authentication.AccountNotVerifiedException"
                                                  value="/login?error=account_not_verified"/>
                <entry key="org.cloudfoundry.identity.uaa.authentication.PasswordExpiredException"
                                                  value="/login?error=password_expired"/>
                <entry key="org.cloudfoundry.identity.uaa.authentication.AuthenticationPolicyRejectionException"
                                                  value="/login?error=account_locked"/>
                <entry key="org.cloudfoundry.identity.uaa.authentication.AccountNotPreCreatedException"
                                                  value="/login?error=account_not_precreated"/>
                <entry key="org.cloudfoundry.identity.uaa.authentication.PasswordChangeRequiredException"
                                                  value="/force_password_change"/>
            </map>
        </property>
        <property name="defaultFailureUrl" value="/login?error=login_failure"/>
    </bean>

    <bean id="uaaAuthenticationFailureHandler"
                    class="org.cloudfoundry.identity.uaa.login.UaaAuthenticationFailureHandler">
        <constructor-arg name="delegate" ref="errorMessageAuthenticationFailureHandler"/>
        <constructor-arg name="currentUserCookieFactory" ref="currentUserCookieFactory"/>
    </bean>

    <bean id="loginEntryPoint" class="org.cloudfoundry.identity.uaa.security.CsrfAwareEntryPointAndDeniedHandler">
        <constructor-arg name="redirectCsrf" value="/invalid_request"/>
        <constructor-arg name="redirectNotLoggedIn" value="/login?error=invalid_login_request"/>
    </bean>

    <bean id="externalOAuthLogoutHandler"
                    class="org.cloudfoundry.identity.uaa.provider.oauth.ExternalOAuthLogoutSuccessHandler">
        <constructor-arg name="providerProvisioning" ref="externalOAuthProviderConfigurator"/>
        <constructor-arg name="oidcMetadataFetcher" ref="oidcMetadataFetcher"/>
        <constructor-arg name="identityZoneManager" ref="identityZoneManager"/>
    </bean>

    <bean id="logoutHandler"
                    class="org.cloudfoundry.identity.uaa.authentication.ZoneAwareWhitelistLogoutSuccessHandler">
        <constructor-arg name="clientDetailsService" ref="jdbcClientDetailsService"/>
        <constructor-arg name="externalOAuthLogoutHandler" ref="externalOAuthLogoutHandler"/>
        <constructor-arg name="keyInfoService" ref="keyInfoService"/>
    </bean>

    <bean id="autologinAuthenticationFilter"
                    class="org.cloudfoundry.identity.uaa.authentication.AuthzAuthenticationFilter">
        <constructor-arg ref="autologinAuthenticationManager"/>
        <property name="parameterNames">
            <list>
                <value>code</value>
                <value>response_type</value>
            </list>
        </property>
        <property name="methods">
            <set>
                <value>GET</value>
                <value>POST</value>
            </set>
        </property>
        <property name="successHandler" ref="accountSavingAuthenticationSuccessHandler"/>
    </bean>

</beans>
